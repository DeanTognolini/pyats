name: pyATS Layer 1 Validation

on:
  # Run on pull requests to main branch
  pull_request:
    branches:
      - main
      - master
    paths:
      - 'layer1_*.py'
      - 'testbed.yaml'
      - 'requirements.txt'
      - 'Dockerfile'
      - '.github/workflows/pyats-validation.yml'

  # Run on push to main branch
  push:
    branches:
      - main
      - master
    paths:
      - 'layer1_*.py'
      - 'testbed.yaml'
      - 'requirements.txt'
      - 'Dockerfile'

  # Allow manual workflow dispatch
  workflow_dispatch:
    inputs:
      testbed:
        description: 'Testbed file to use'
        required: false
        default: 'testbed.yaml'
      log_level:
        description: 'Log level (DEBUG, INFO, WARNING, ERROR)'
        required: false
        default: 'INFO'

  # Optional: Run on a schedule (e.g., daily at 2 AM UTC)
  # Uncomment to enable scheduled runs
  # schedule:
  #   - cron: '0 2 * * *'

jobs:
  # Lint and syntax check job
  lint:
    name: Lint and Syntax Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install linting dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 pylint black

      - name: Check code formatting with Black
        run: |
          black --check --diff layer1_*.py

      - name: Lint with flake8
        run: |
          # Stop the build if there are Python syntax errors or undefined names
          flake8 layer1_*.py --count --select=E9,F63,F7,F82 --show-source --statistics
          # Exit-zero treats all errors as warnings
          flake8 layer1_*.py --count --exit-zero --max-complexity=10 --max-line-length=120 --statistics

      - name: Lint with pylint
        run: |
          pylint layer1_*.py --exit-zero --max-line-length=120

  # Validate testbed YAML syntax
  validate-testbed:
    name: Validate Testbed YAML
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install PyYAML
        run: pip install pyyaml

      - name: Validate YAML syntax
        run: |
          python -c "import yaml; yaml.safe_load(open('testbed.yaml'))"

  # Docker build test
  docker-build:
    name: Docker Build Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: pyats-layer1:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Test Docker image
        run: |
          docker run --rm pyats-layer1:test python --version
          docker run --rm pyats-layer1:test pip list | grep pyats

  # pyATS syntax validation (dry run)
  pyats-syntax:
    name: pyATS Syntax Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Validate pyATS job syntax
        run: |
          python -m py_compile layer1_job.py
          python -m py_compile layer1_tests.py

      - name: Check testbed loading
        run: |
          python -c "from pyats.topology import loader; loader.load('testbed.yaml')"
        continue-on-error: true

  # Unit tests (if you have any)
  # Uncomment this job if you add unit tests
  # unit-tests:
  #   name: Unit Tests
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #
  #     - name: Set up Python
  #       uses: actions/setup-python@v5
  #       with:
  #         python-version: '3.11'
  #         cache: 'pip'
  #
  #     - name: Install dependencies
  #       run: |
  #         python -m pip install --upgrade pip
  #         pip install -r requirements.txt
  #         pip install pytest pytest-cov
  #
  #     - name: Run unit tests
  #       run: |
  #         pytest tests/ --cov=. --cov-report=xml --cov-report=html
  #
  #     - name: Upload coverage reports
  #       uses: codecov/codecov-action@v3
  #       with:
  #         files: ./coverage.xml

  # Security scanning
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install safety bandit

      - name: Check for known security vulnerabilities
        run: |
          # Check installed packages for known vulnerabilities
          pip install -r requirements.txt
          safety check --json || true

      - name: Run Bandit security linter
        run: |
          bandit -r layer1_*.py -f json -o bandit-report.json || true
          cat bandit-report.json

      - name: Upload Bandit report
        uses: actions/upload-artifact@v4
        with:
          name: bandit-security-report
          path: bandit-report.json

  # Summary job
  validation-summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [lint, validate-testbed, docker-build, pyats-syntax, security-scan]
    if: always()
    steps:
      - name: Check job results
        run: |
          echo "Validation Results:"
          echo "  Lint: ${{ needs.lint.result }}"
          echo "  Testbed Validation: ${{ needs.validate-testbed.result }}"
          echo "  Docker Build: ${{ needs.docker-build.result }}"
          echo "  pyATS Syntax: ${{ needs.pyats-syntax.result }}"
          echo "  Security Scan: ${{ needs.security-scan.result }}"

      - name: Set overall status
        if: |
          needs.lint.result != 'success' ||
          needs.validate-testbed.result != 'success' ||
          needs.docker-build.result != 'success' ||
          needs.pyats-syntax.result != 'success'
        run: |
          echo "::error::One or more validation checks failed"
          exit 1

# Optional: Continuous Network Testing Job
# This job would run actual tests against network devices
# WARNING: Only enable if you have a test network accessible from GitHub Actions
# and proper secrets configured
#
# network-testing:
#   name: Network Testing
#   runs-on: ubuntu-latest
#   # Only run on main branch or manual dispatch, not on PRs
#   if: github.event_name != 'pull_request'
#   needs: [lint, validate-testbed, docker-build]
#   steps:
#     - name: Checkout code
#       uses: actions/checkout@v4
#
#     - name: Set up Python
#       uses: actions/setup-python@v5
#       with:
#         python-version: '3.11'
#         cache: 'pip'
#
#     - name: Install dependencies
#       run: |
#         python -m pip install --upgrade pip
#         pip install -r requirements.txt
#
#     - name: Run pyATS tests
#       env:
#         PYATS_USERNAME: ${{ secrets.PYATS_USERNAME }}
#         PYATS_PASSWORD: ${{ secrets.PYATS_PASSWORD }}
#       run: |
#         pyats run job layer1_job.py \
#           --testbed testbed.yaml \
#           --html-logs ./reports/ \
#           --json-logs ./reports/ \
#           --loglevel ${{ inputs.log_level || 'INFO' }}
#
#     - name: Upload test reports
#       if: always()
#       uses: actions/upload-artifact@v4
#       with:
#         name: pyats-test-reports
#         path: |
#           reports/
#           archive/
#         retention-days: 30
#
#     - name: Publish test results summary
#       if: always()
#       run: |
#         # Parse results and create summary
#         python -c "
#         import json
#         import sys
#         try:
#             with open('reports/job.results.json') as f:
#                 results = json.load(f)
#             passed = results.get('passed', 0)
#             failed = results.get('failed', 0)
#             total = results.get('total', 0)
#             print(f'## Test Results Summary')
#             print(f'- Total Tests: {total}')
#             print(f'- Passed: {passed}')
#             print(f'- Failed: {failed}')
#             print(f'- Success Rate: {(passed/total*100):.1f}%' if total > 0 else 'N/A')
#             sys.exit(0 if failed == 0 else 1)
#         except Exception as e:
#             print(f'Failed to parse results: {e}')
#             sys.exit(1)
#         " >> $GITHUB_STEP_SUMMARY
